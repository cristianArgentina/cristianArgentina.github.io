<!-- admin.html -->
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="admin.css" />
  <link rel="stylesheet" href="./modules/css/loaderadmin.css">
</head>

<body>
  <h1>üì¶ Panel de Administraci√≥n</h1>
  <main id="content">
    <!-- primero carga el login -->
    <login-box></login-box>
  </main>
  <script type="module" src="./modules/js/login.js"></script>
  <script type="module" src="admin.js"></script>

  <script type="module">
    /*
    import { API_URL } from './config.js';
    import { getProducts, getProductById, createProduct, updateProduct, deleteProduct, addLote, deleteLote } from './api.js';
    import { showLoader, hideLoader } from "./js/loaderadmin.js";

    let productos = [];
    const categoriasDisponibles = ["belleza y salud", "hogar", "tecnologia", "iluminacion"];
    let productoActual = null;

    // Llamar a esta funci√≥n al iniciar
    cargarOpcionesCategoria();

    async function cargarProductos() {
      showLoader("Cargando productos... üê•");
      try {
        tablaProductos.innerHTML = "";
        const productos = await getProducts();
        productos.forEach(prod => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
    <td>${prod.name}</td>
    <td>$${prod.price}</td>
    <td>${prod.stock}</td>
    <td>${prod.category || "Sin categor√≠a"}</td>
    <td>
      <button class="btn-primary" onclick="editarProducto(${prod.id})">‚úèÔ∏è</button>
      <button class="btn-danger" onclick="eliminarProducto(${prod.id})">üóëÔ∏è</button>
    </td>
    <td>
      <button class="btn-secondary" onclick="mostrarFormLote(${prod.id})">‚ûï Lote</button>
      <div id="formLote-${prod.id}" class="form-lote" style="display:none; margin-top:5px;">
        <input type="number" id="cantidad-${prod.id}" placeholder="Cantidad" min="1" required>
        <input type="number" id="costo-${prod.id}" placeholder="Costo unitario" step="0.01">
        <input type="date" id="fecha-${prod.id}">
        <button onclick="guardarLote(${prod.id})">Guardar</button>
      </div>
    </td>
  `;
          tablaProductos.appendChild(tr);
        });
      } finally {
        hideLoader();
      }
    }

    // Funci√≥n para llenar el <select> din√°micamente
    // Funci√≥n para llenar el <select> din√°micamente en cualquier modal
    function cargarOpcionesCategoria(selectId) {
      const categorySelect = document.getElementById(selectId);
      if (!categorySelect) return; // seguridad por si no existe el select

      categorySelect.innerHTML = `<option value="">Seleccionar categor√≠a</option>`;

      categoriasDisponibles.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
    }


    window.editarProducto = async (id) => {
      cargarOpcionesCategoria("categoryEdit");
      const producto = await getProductById(id);
      productoActual = producto;
      formTitulo.textContent = "Editar Producto";
      formEditProducto.productIdEdit.value = producto.id;
      formEditProducto.nameEdit.value = producto.name;
      formEditProducto.descriptionEdit.value = producto.description || "";
      formEditProducto.categoryEdit.value = producto.category || "";
      formEditProducto.priceEdit.value = producto.price;
      formEditProducto.imageEdit.value = producto.image || "";
      formEditProducto.stockEdit.value = producto.stock;

      renderLotes(producto.lotes);
      document.getElementById("modalEdit").style.display = "block";
    };

    function renderLotes(lotes) {
      const tbody = document.querySelector("#tablaLotes tbody");
      tbody.innerHTML = "";
      lotes.forEach((lote) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
    <td>${lote.cantidad}</td>
    <td>${lote.costoUnitario ?? "-"}</td>
    <td>${new Date(lote.fechaIngreso).toLocaleDateString()}</td>
    <td>
      <button onclick="eliminarLote('${lote._id}')">üóëÔ∏è</button>
    </td>
  `;
        tbody.appendChild(tr);
      });
    }

    window.eliminarLote = async (loteId) => {
      if (confirm("¬øEliminar este lote?")) {
        await deleteLote(productoActual.id, loteId);
        const actualizado = await getProductById(productoActual.id);
        productoActual = actualizado;
        renderLotes(actualizado.lotes);
        cargarProductos();
      }
    };

    window.mostrarFormLote = (id) => {
      const form = document.getElementById(`formLote-${id}`);
      form.style.display = form.style.display === "none" ? "block" : "none";
    };

    window.guardarLote = async (id) => {
      const cantidad = parseInt(document.getElementById(`cantidad-${id}`).value);
      const costoUnitario = parseFloat(document.getElementById(`costo-${id}`).value) || null;
      const fechaIngreso = document.getElementById(`fecha-${id}`).value || null;

      if (!cantidad) {
        alert("La cantidad es obligatoria");
        return;
      }

      await addLote(id, { cantidad, costoUnitario, fechaIngreso });
      alert("‚úÖ Lote agregado correctamente");

      // refrescamos productos
      cargarProductos();
    };

    window.eliminarProducto = async (id) => {
      if (confirm("¬øSeguro que deseas eliminar este producto?")) {
        await deleteProduct(id);
        cargarProductos();
      }
    };

    btnNuevo.addEventListener("click", () => {
      cargarOpcionesCategoria("categoryAdd");
      formTitulo.textContent = "Agregar Nuevo Producto";
      formAddProducto.reset();
      document.getElementById("modalAdd").style.display = "block";
    });

    formAddProducto.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        name: formAddProducto.nameAdd.value,
        description: formAddProducto.descriptionAdd.value,
        category: formAddProducto.categoryAdd.value,
        price: parseFloat(formAddProducto.priceAdd.value),
        image: formAddProducto.imageAdd.value,
        stock: parseInt(formAddProducto.stockAdd.value)
      };
      await createProduct(data);
      cerrarModal();
      cargarProductos();
    });

    formEditProducto.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        name: formEditProducto.nameEdit.value,
        description: formEditProducto.descriptionEdit.value,
        category: formEditProducto.categoryEdit.value,
        price: parseFloat(formEditProducto.priceEdit.value),
        image: formEditProducto.imageEdit.value,
        stock: parseInt(formEditProducto.stockEdit.value)
      };
      await updateProduct(formEditProducto.productIdEdit.value, data);
      cerrarModal();
      cargarProductos();
    });

    function cerrarModal() {
      document.querySelectorAll(".modal").forEach(m => m.style.display = "none");
    }

    // Cerrar cualquier modal al apretar su bot√≥n close
    document.querySelectorAll(".modal .close").forEach(closeBtn => {
      closeBtn.addEventListener("click", () => {
        closeBtn.closest(".modal").style.display = "none";
      });
    });

    // Cerrar al hacer click fuera del contenido del modal
    window.addEventListener("click", (e) => {
      if (e.target.classList.contains("modal")) {
        e.target.style.display = "none";
      }
    });

    cargarProductos();*/
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">/*


const btnNuevaVenta = document.getElementById("btnNuevaVenta");
const tablaVentas = document.querySelector("#tablaVentas tbody");

 


// Abrir modal venta
btnNuevaVenta.addEventListener("click", async () => {
const productos = await getProducts();
const select = document.getElementById("ventaProducto");
select.innerHTML = "";
productos.forEach(p => {
const option = document.createElement("option");
option.value = p.id;
option.textContent = p.name;
select.appendChild(option);
});
modalVenta.style.display = "block";
});

// Guardar venta
formVenta.addEventListener("submit", async (e) => {
e.preventDefault();

const productId = ventaProducto.value;
const cantidad = parseInt(ventaCantidad.value);
const precioVenta = parseFloat(ventaPrecio.value);

await createSale({ productId, cantidad, precioVenta });

modalVenta.style.display = "none";
cargarVentas(); // refresca la tabla de ventas
});

    /*
  <div id="vistaProductos">
      <button id="btnNuevo" class="btn-primary">‚ûï Agregar nuevo producto</button>
      <table id="tablaProductos">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Categor√≠a</th>
            <th>Acciones</th>
            <th>Lotes</th> <!-- nueva columna -->
          </tr >
        </thead >
      <tbody></tbody>
      </table >
    </div >
      <div id="contenedorVentas"></div>
  </div >
  </div >
  < !--addModal -->
  <div id="modalAdd" class="modal">
    <div class="modal-content">
      <span id="closeAddModalBtn" class="close">&times;</span>
      <h2 id="formTitulo">Agregar Producto</h2>
      <form id="formAddProducto">
        <input type="hidden" id="productId">

        <!-- Nombre -->
        <div class="form-group">
          <label for="nameAdd">Nombre</label>
          <input type="text" id="nameAdd" class="form-control" required>
        </div>

        <!-- Descripci√≥n -->
        <div class="form-group">
          <label for="descriptionAdd">Descripci√≥n</label>
          <textarea id="descriptionAdd" class="form-control"></textarea>
        </div>

        <!-- Precio + Stock en la misma fila -->
        <div class="form-row">
          <div class="form-group half">
            <label for="priceAdd">Precio</label>
            <input type="number" id="priceAdd" class="form-control" required>
          </div>
          <div class="form-group half">
            <label for="stockAdd">Stock</label>
            <input type="number" id="stockAdd" class="form-control" required>
          </div>
        </div>

        <!-- Categor√≠a -->
        <div class="form-group">
          <label for="categoryAdd">Categor√≠a</label>
          <select name="category" id="categoryAdd" class="form-control" required></select>
        </div>

        <!-- Imagen -->
        <div class="form-group">
          <label for="imageAdd">Imagen URL</label>
          <input type="text" id="imageAdd" class="form-control">
        </div>

        <button type="submit" class="btn-primary">üíæ Guardar</button>
      </form>
    </div>
  </div>
  <!--editModal -->
  <div id="modalEdit" class="modal">
    <div class="modal-content">
      <span id="closeEditModalBtn" class="close">&times;</span>
      <h2 id="formTitulo">Editar Producto</h2>
      <form id="formEditProducto">
        <input type="hidden" id="productIdEdit">

        <!-- Nombre -->
        <div class="form-group">
          <label for="nameEdit">Nombre</label>
          <input type="text" id="nameEdit" class="form-control" required>
        </div>

        <!-- Descripci√≥n -->
        <div class="form-group">
          <label for="descriptionEdit">Descripci√≥n</label>
          <textarea id="descriptionEdit" class="form-control"></textarea>
        </div>

        <!-- Precio + Stock en la misma fila -->
        <div class="form-row">
          <div class="form-group half">
            <label for="priceEdit">Precio</label>
            <input type="number" id="priceEdit" class="form-control" required>
          </div>
          <div class="form-group half">
            <label for="stockEdit">Stock</label>
            <input type="number" id="stockEdit" class="form-control" required>
          </div>
        </div>

        <!-- Categor√≠a -->
        <div class="form-group">
          <label for="categoryEdit">Categor√≠a</label>
          <select name="category" id="categoryEdit" class="form-control" required></select>
        </div>

        <!-- Imagen -->
        <div class="form-group">
          <label for="imageEdit">Imagen URL</label>
          <input type="text" id="imageEdit" class="form-control">
        </div>

        <button type="submit" class="btn-primary">üíæ Guardar</button>
      </form>
      <!-- Secci√≥n de lotes separada -->
      <hr>
      <h3>üì¶ Lotes del producto</h3>
      <table id="tablaLotes">
        <thead>
          <tr>
            <th>Cantidad</th>
            <th>Costo Unitario</th>
            <th>Fecha Ingreso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
        */
  </script>
</body>

</html>