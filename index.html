<!DOCTYPE html>
<html lang="es">

<head>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-89F6NB7TVR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-89F6NB7TVR');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat√°logo de Productos</title>

</head>

<body>
  <div class="barra-superior">
    <h1 class="titulo-pagina">
      <i class="fas fa-shopping-cart icono-carrito"></i> Cat√°logo de Productos
    </h1>
    <div class="buscador-con-icono">
      <i class="fas fa-search"></i>
      <input type="text" id="buscador" placeholder="Buscar productos...">
    </div>
    <select id="categoriaSelector">
      <option value="">Todas las categor√≠as</option>
      <option value="belleza y salud" selected>Belleza y salud</option>
      <option value="hogar">Hogar</option>
      <option value="tecnologia">Tecnolog√≠a</option>
      <option value="iluminacion">Iluminaci√≥n</option>
    </select>
  </div>
  <div id="categorias" class="categorias-container">
  </div>
  <div class="productos" id="contenedor-productos">
  </div>

  <p id="no-results">No se encontraron productos que coincidan con la b√∫squeda o filtro.</p>

  <script type="module">
    import { API_URL } from './config.js';

    // Variables DOM declaradas al inicio
    const loader = document.getElementById('loader-container');
    const contenedor = document.getElementById('contenedor-productos');
    const buscador = document.getElementById('buscador');
    const categoriaSelector = document.getElementById('categoriaSelector');
    const noResults = document.getElementById('no-results');
    let categorySelected = ''

    // Lista de productos original para filtrado
    let productosOriginales = [];

    /*
      <div id="loader-container">
        Cargando<span class="dots"><span>.</span><span>.</span><span>.</span></span>
      </div>

      showLoader();
      hideLoader();

    */
    const categorias = [
      { id: "belleza y salud", nombre: "Belleza y Salud", icono: "üß¥" },
      { id: "hogar", nombre: "Hogar", icono: "üè†" },
      { id: "tecnologia", nombre: "Tecnolog√≠a", icono: "üíª" },
      { id: "iluminacion", nombre: "Iluminaci√≥n", icono: "üí°" },
    ];

    function renderCategorias() {
      const cont = document.getElementById("categorias");
      cont.innerHTML = categorias.map(c => `
    <div class="card-categoria" data-id="${c.id}">
      <span class="icono">${c.icono}</span>
      <h3>${c.nombre}</h3>
    </div>
  `).join("");
    }
    renderCategorias();

    buscador.addEventListener('input', () => filtrarYOrdenar(productosOriginales));
    categoriaSelector.addEventListener('change', () => filtrarYOrdenar(productosOriginales));

    async function precargarProductos() {
      try {
        const res = await fetch(`${API_URL}/products`);
        if (!res.ok) throw new Error('Error en la respuesta de la API');
        const productos = await res.json();

        const productosElems = productos.map(p => crearProductoElem(p));
        productosElems.forEach(e => contenedor.appendChild(e));

        productosOriginales = [...productosElems];

      } catch (err) {
        console.error("Error al despertar backend", err);
        noResults.textContent = 'Error al cargar los productos.';
        noResults.style.display = 'block';
      }
    }
    precargarProductos();

    document.getElementById("categorias").addEventListener("click", async (e) => {
      const card = e.target.closest(".card-categoria");
      if (!card) return;

      //const catId = card.dataset.id;
      categorySelected = card.dataset.id;

      if (productosOriginales.length > 0) {
        // ‚úÖ Mostramos de cach√©
        filtrarYOrdenar(productosOriginales);
      } else {
        contenedor.innerHTML = `<div id="loader-container">
        Cargando<span class="dots"><span>.</span><span>.</span><span>.</span></span>
      </div>`;
        // ‚ùå Si a√∫n no hay cach√©, pedimos al backend
        await precargarProductos()
        filtrarYOrdenar(productosOriginales);
      }
    });

    // Carga de YouTube
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function crearProductoElem(p) {
      const div = document.createElement('div');
      div.className = 'producto' + (p.videos.length > 0 ? ' producto-video' : '') + (p.stock <= 0 ? ' agotado' : '');
      div.dataset.categoria = p.category;
      div.dataset.precio = p.price;
      if (p.videos.length > 0) div.dataset.videos = p.videos.join(',');

      if (p.videos.length > 0) {
        const vidCont = document.createElement('div');
        vidCont.className = 'video-container';
        div.appendChild(vidCont);
      } else {
        const imgWrapper = document.createElement('div');
        imgWrapper.className = 'img-wrapper';
        imgWrapper.innerHTML = `
          <img src="${p.image}" alt="${p.name}">
          ${p.stock <= 0 ? '<div class="marca-agua">AGOTADO</div>' : ''}
          `;
        div.appendChild(imgWrapper);
      }

      const info = document.createElement('div');
      info.className = 'info';
      info.innerHTML = `
          <h2>${p.name}</h2>
          <p>${p.description}</p>
          <div class="precio-wsp">
            <p class="precio">$${p.price.toLocaleString()}</p>
            <a class="whatsapp-btn"
              href="https://wa.me/5491138863899?text=Hola,%20quiero%20consultar%20por%20el%20producto:%20${encodeURIComponent(p.name)}" 
              target="_blank" 
              title="Consultar por WhatsApp">
              <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height: 36px;">
            </a>
          </div>
        `;
      div.appendChild(info);
      // Alerta visual de stock bajo
      if (p.stock > 0) {
        const stockAlert = document.createElement('div');
        stockAlert.className = 'stock-alert';

        if (p.stock <= 2) {
          stockAlert.textContent = '¬°√öltimas unidades!';
          stockAlert.classList.add('stock-bajo');
        } else {
          stockAlert.textContent = 'Disponible';
          stockAlert.classList.add('stock-alto');
        }

        div.appendChild(stockAlert);
      }
      return div;
    }

    function filtrarYOrdenar(productosElems) {
      const texto = buscador.value.toLowerCase();
      categorySelected = categoriaSelector.value;

      let lista = productosElems;

      if (categorySelected) {
        lista = lista.filter(e => (e.dataset.categoria || '').toLowerCase() === categorySelected.toLowerCase());
      }

      lista = lista.filter(e =>
        e.innerText.toLowerCase().includes(texto)
      );

      const ordenados = [...lista].sort((a, b) =>
        Number(b.dataset.precio) - Number(a.dataset.precio)
      );

      contenedor.innerHTML = '';
      ordenados.forEach(e => contenedor.appendChild(e));
      if (window.inicializarVideosYouTube) inicializarVideosYouTube();
      noResults.style.display = ordenados.length === 0 ? 'block' : 'none';
    }

    // Funci√≥n para inicializar videos YouTube (de tu c√≥digo original)
    window.inicializarVideosYouTube = () => {
      document.querySelectorAll('.producto-video').forEach((prod, i) => {
        if (prod.dataset.videoReady) return;
        const ids = prod.dataset.videos.split(',');
        const playerId = `yt-${i}-${Date.now()}`;
        const iframe = document.createElement('iframe');
        iframe.id = playerId;
        iframe.src = `https://www.youtube.com/embed/${ids[0]}?enablejsapi=1&mute=1&rel=0&controls=0`;
        iframe.allow = "autoplay; fullscreen; encrypted-media";
        iframe.frameBorder = 0;
        prod.querySelector('.video-container').appendChild(iframe);

        new YT.Player(playerId, {
          events: {
            onReady: e => { e.target.mute(); e.target.playVideo(); },
            onStateChange: ev => {
              if (ev.data === YT.PlayerState.ENDED) {
                const ply = ev.target;
                ply.loadVideoById(ids[(ply.currentIndex = ((ply.currentIndex || 0) + 1) % ids.length)]);
                ply.mute(); ply.playVideo();
              }
            }
          }
        });
        prod.dataset.videoReady = true;
      });
    };

    window.onYouTubeIframeAPIReady = window.inicializarVideosYouTube;
  </script>

</body>

</html>