<!DOCTYPE html>
<html lang="es">

<head>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="./admin/modules/css/loader-wake-up-backend.css">
  <link rel="stylesheet" href="./admin/modules/css/loader-instructivo.css">
    <link rel="stylesheet" href="./admin/modules/css/menu-categorias.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-89F6NB7TVR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-89F6NB7TVR');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat√°logo de Productos</title>

</head>

<body>
  <div class="barra-superior">
    <h1 class="titulo-pagina">
      <i class="fas fa-shopping-cart icono-carrito"></i> Cat√°logo de Productos
    </h1>
    <div class="buscador-con-icono">
      <i class="fas fa-search"></i>
      <input type="text" id="buscador" placeholder="Buscar productos...">
    </div>
  </div>
  <div class="menu">
  <button id="toggleBtn" class="menu-btn">
    ELIGE CATEGORIA
    <span class="arrow">‚ñº</span>
  </button>

  <ul id="menuList" class="menu-list">
    <li data-id="belleza y salud">üß¥ - Belleza y Salud</li>
    <li data-id="hogar">üè† - Hogar</li>
    <li data-id="tecnologia">üíª - Tecnolog√≠a</li>
    <li data-id="iluminacion">üí° - Iluminaci√≥n</li>
    <li data-id="">üì¶ - Todas</li>
  </ul>
</div>
  
  <div id="instruccion">
    üëâ Selecciona una categor√≠a para explorar productos
  </div>
  <div class="productos" id="contenedor-productos">
  </div>
<button id="cart-float" class="cart-float">
  <i class="fas fa-shopping-cart"></i>
  <span id="cart-count" class="cart-count">0</span>
</button>


  <p id="no-results">No se encontraron productos que coincidan con la b√∫squeda o filtro.</p>
  
  <script type="module">
    import { API_URL } from './config.js';
    //import { initLoaderArt } from './admin/modules/js/loader-wake-up-backend.js';
    import { initLoaderInstructivo } from './admin/modules/js/loader-instructivo.js';

    // Variables DOM declaradas al inicio
    //   const loader = document.getElementById('loader-container');
    const hideLoader = initLoaderInstructivo();
    const contenedor = document.getElementById('contenedor-productos');
    const buscador = document.getElementById('buscador');
    const noResults = document.getElementById('no-results');
    let categorySelected = ''

    // Lista de productos original para filtrado
    let productosOriginales = [];
    /*
        function mostrarLoader() {
          loader.style.display = "flex";
        }
        function ocultarLoader() {
          loader.style.display = "none";
        }
    */

      const toggleBtn = document.getElementById("toggleBtn");
  const menuList = document.getElementById("menuList");

  toggleBtn.addEventListener("click", () => {
    menuList.classList.toggle("active");
    toggleBtn.classList.toggle("active");
  });
    
    buscador.addEventListener('input', () => filtrarYOrdenar(productosOriginales));

    async function cargarProductosDesdeJSON() {
      const res = await fetch('/assets/csv/productosactuales.json');
      if (!res.ok) throw new Error('No se pudo cargar JSON local');
      return await res.json();
    }

    function normalizarProducto(p) {
      return {
        ...p,
        image: p.image || null,
        videos: Array.isArray(p.videos) ? p.videos : [],
        stock: Number(p.stock) || 0,
        price: Number(p.price) || 0
      };
    }

    async function precargarProductos() {
      try {
        const productos = await cargarProductosDesdeJSON();
        productosOriginales = productos.map(p => crearProductoElem(normalizarProducto(p)));
      } catch (e) {
        console.error(e);
        noResults.textContent = 'Error al cargar productos locales.';
        noResults.style.display = 'block';
      }
    }

    /*
        async function precargarProductos() {
          try {
            const res = await fetch(`${API_URL}/products`);
            if (!res.ok) throw new Error('Error en la respuesta de la API');
            const productos = await res.json();
            //  setTimeout(() => {
            hideLoader();
            //  }, 9900); // un mini delay para que se note
    
            const productosElems = productos.map(p => crearProductoElem(p));
            productosOriginales = [...productosElems];
    
          } catch (err) {
            console.error("Error al despertar backend", err);
            noResults.textContent = 'Error al cargar los productos.';
            noResults.style.display = 'block';
            hideLoader();
          }
        }
    */
    async function actualizarDesdeBackend() {
      try {
        const res = await fetch(`${API_URL}/products`);
        if (!res.ok) throw new Error('Backend no disponible');

        const productos = await res.json();

        // Reemplazar datos en memoria
        renderProductosDesdeDatos(productos);

        // Re-render si hay categor√≠a activa
        if (categorySelected) {
          filtrarYOrdenar(productosOriginales);
        }

        console.info('Productos actualizados desde backend');

      } catch (err) {
        console.warn('Backend a√∫n dormido');
      }
    }

    function renderProductosDesdeDatos(productos) {
      productosOriginales = productos.map(p =>
        crearProductoElem(normalizarProducto(p))
      );
    }

    (async () => {
      // 2Ô∏è‚É£ Cargar json inmediatamente
      await precargarProductos();

      // 3Ô∏è‚É£ Ocultar loader (no depende del backend)
      hideLoader();

      filtrarYOrdenar(productosOriginales);

      // 4Ô∏è‚É£ Backend en segundo plano
      actualizarDesdeBackend();
    })();
/*
    const wspBtn = document.getElementById("whatsapp-float");

    wspBtn.addEventListener("click", () => {
      const seleccionados = [...document.querySelectorAll(".producto-check:checked")]
        .map(chk => chk.dataset.nombre);

      if (seleccionados.length === 0) {
        alert("Selecciona al menos un producto para consultar");
        return;
      }

      const mensaje = `Hola, me interesan los siguientes productos:\n- ${seleccionados.join("\n- ")}`;
      const url = `https://wa.me/5491138863899?text=${encodeURIComponent(mensaje)}`;

      window.open(url, "_blank");
    });
*/

const cartBtn = document.getElementById("cart-float");
const cartCount = document.getElementById("cart-count");

function actualizarContador() {
  const seleccionados = document.querySelectorAll(".producto-check:checked");
  cartCount.textContent = seleccionados.length;
}

document.addEventListener("change", (e) => {
  if (e.target.classList.contains("producto-check")) {
    actualizarContador();
  }
});

cartBtn.addEventListener("click", () => {
  const seleccionados = [...document.querySelectorAll(".producto-check:checked")]
    .map(chk => chk.dataset.nombre);

  if (seleccionados.length === 0) {
    alert("No hay productos seleccionados");
    return;
  }

  alert("Productos en carrito:\n\n" + seleccionados.join("\n"));
});
    
    
    menuList.addEventListener("click", (e) => {
  const item = e.target.closest("li");
  if (!item) return;

  // 1Ô∏è‚É£ Guardar categor√≠a seleccionada
  categorySelected = item.dataset.id;

  // 2Ô∏è‚É£ Ocultar mensaje inicial
  document.getElementById("instruccion").style.display = "none";

  // 3Ô∏è‚É£ Filtrar productos
  filtrarYOrdenar(productosOriginales);

  // 4Ô∏è‚É£ Cerrar men√∫
  menuList.classList.remove("active");
  toggleBtn.classList.remove("active");
});

    // Carga de YouTube
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function crearProductoElem(p) {
      const div = document.createElement('div');
      div.className = 'producto' + (p.videos.length > 0 ? ' producto-video' : '') + (p.stock <= 0 ? ' agotado' : '');
      div.dataset.categoria = p.category;
      div.dataset.precio = p.price;
      div.dataset.stock = p.stock;
      if (p.videos.length > 0) div.dataset.videos = p.videos.join(',');

      if (p.videos.length > 0) {
        const vidCont = document.createElement('div');
        vidCont.className = 'video-container';
        div.appendChild(vidCont);
      } else if (p.image) {
        const imgWrapper = document.createElement('div');
        imgWrapper.className = 'img-wrapper';
        imgWrapper.innerHTML = `
          <img src="${p.image}" alt="${p.name}">
          ${p.stock <= 0 ? '<div class="marca-agua">AGOTADO</div>' : ''}
          `;
        div.appendChild(imgWrapper);
      }

      const info = document.createElement('div');
      info.className = 'info';
      info.innerHTML = `
          <h2>${p.name}</h2>
          <p>${p.description}</p>
          <div class="precio-carrito">
            <span class="precio">$${p.price.toLocaleString()}</span>
            <button class="btn-agregar"
              data-id="${p.id || p.name}"
              data-nombre="${p.name}"
              data-precio="${p.price}">
              Agregar
            </button>
          </div>
        `;
      div.appendChild(info);
      // Alerta visual de stock bajo
      if (p.stock > 0) {
        const stockAlert = document.createElement('div');
        stockAlert.className = 'stock-alert';

        if (p.stock <= 2) {
          stockAlert.textContent = '¬°√öltimas unidades!';
          stockAlert.classList.add('stock-bajo');
        } else {
          stockAlert.textContent = 'Disponible';
          stockAlert.classList.add('stock-alto');
        }

        div.appendChild(stockAlert);
      }
      return div;
    }

    /*
                <a class="whatsapp-btn"
                  href="https://wa.me/5491138863899?text=Hola,%20quiero%20consultar%20por%20el%20producto:%20${encodeURIComponent(p.name)}" 
                  target="_blank" 
                  title="Consultar por WhatsApp">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height: 36px;">
                </a>
    */

    function filtrarYOrdenar(productosElems) {
      const texto = buscador.value.toLowerCase();

      let lista = productosElems;

      if (categorySelected) {
        lista = lista.filter(e => (e.dataset.categoria || '').toLowerCase() === categorySelected.toLowerCase());
      }

      lista = lista.filter(e =>
        e.innerText.toLowerCase().includes(texto)
      );

const ordenados = [...lista].sort((a, b) => {
  const stockA = Number(a.dataset.stock);
  const stockB = Number(b.dataset.stock);

  // üëâ agotados al final SIEMPRE
  if (stockA === 0 && stockB !== 0) return 1;
  if (stockB === 0 && stockA !== 0) return -1;

  // üëâ despu√©s ordenar por precio (tu criterio actual)
  return Number(a.dataset.precio) - Number(b.dataset.precio);
});

      contenedor.innerHTML = '';
      ordenados.forEach(e => contenedor.appendChild(e));
      if (window.inicializarVideosYouTube) inicializarVideosYouTube();
      noResults.style.display = ordenados.length === 0 ? 'block' : 'none';
    }

    // Funci√≥n para inicializar videos YouTube (de tu c√≥digo original)
    window.inicializarVideosYouTube = () => {
      document.querySelectorAll('.producto-video').forEach((prod, i) => {
        if (prod.dataset.videoReady) return;
        const raw = prod.dataset.videos;
        if (!raw) return;
        const ids = raw.split(',');
        const playerId = `yt-${i}-${Date.now()}`;
        const iframe = document.createElement('iframe');
        iframe.id = playerId;
        iframe.src = `https://www.youtube.com/embed/${ids[0]}?enablejsapi=1&mute=1&rel=0&controls=0`;
        iframe.allow = "autoplay; fullscreen; encrypted-media";
        iframe.frameBorder = 0;
        prod.querySelector('.video-container').appendChild(iframe);

        new YT.Player(playerId, {
          events: {
            onReady: e => { e.target.mute(); e.target.playVideo(); },
            onStateChange: ev => {
              if (ev.data === YT.PlayerState.ENDED) {
                const ply = ev.target;
                ply.loadVideoById(ids[(ply.currentIndex = ((ply.currentIndex || 0) + 1) % ids.length)]);
                ply.mute(); ply.playVideo();
              }
            }
          }
        });
        prod.dataset.videoReady = true;
      });
    };

    window.onYouTubeIframeAPIReady = window.inicializarVideosYouTube;
  </script>

</body>

</html>
