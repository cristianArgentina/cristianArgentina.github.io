<!-- admin.html -->
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="admin.css" />
</head>

<body>
  <div id="login-box">
    <h2>Acceso restringido</h2>
    <input type="password" id="password" placeholder="Contrase√±a" />
    <button onclick="checkPassword()">Entrar</button>
    <p id="msg" style="color:red;"></p>
  </div>

  <div id="admin-content" style="display:none;">
    <h1>üì¶ Panel de Administraci√≥n</h1>

    <button id="btnNuevo" class="btn-primary">‚ûï Agregar nuevo producto</button>

    <table id="tablaProductos">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Stock</th>
          <th>Categor√≠a</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Modal -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span id="closeModalBtn" class="close">&times;</span>
        <h2 id="formTitulo">Editar Producto</h2>
        <form id="formProducto">
          <input type="hidden" id="productId">

          <label>Nombre:</label>
          <input type="text" id="name" required>

          <label>Descripci√≥n:</label>
          <textarea id="description"></textarea>

          <label>Categor√≠a:</label>
          <select name="category" id="category" required></select>

          <label>Precio:</label>
          <input type="number" id="price" step="0.01" required>

          <label>Imagen URL:</label>
          <input type="text" id="image">

          <label>Stock:</label>
          <input type="number" id="stock" required>

          <button type="submit" class="btn-primary">üíæ Guardar</button>
        </form>
      </div>
    </div>

    <script type="module">
      import { getProducts, getProductById, createProduct, updateProduct, deleteProduct } from './api.js';
      const claveCorrecta = "TuClaveSecreta123";

      function mostrarLogin() {
        document.getElementById("login-box").style.display = "block";
      }

      function mostrarAdmin() {
        document.getElementById("admin-content").style.display = "block";
      }

      // LOGIN
      function checkPassword() {
        const input = document.getElementById("password").value;
        if (input === claveCorrecta) {
          localStorage.setItem("logueadoAdmin", "true");
          location.reload();
        } else {
          document.getElementById("msg").textContent = "Contrase√±a incorrecta";
        }
      }

      if (localStorage.getItem("logueadoAdmin") === "true") {
        document.getElementById("login-box").style.display = "none";
        document.getElementById("admin-content").style.display = "block";
      }

      // Verificar al cargar
      if (localStorage.getItem("logueadoAdmin") === "true") {
        mostrarAdmin();
      } else {
        mostrarLogin();
      }
      window.checkPassword = checkPassword;
    </script>
    <script type="module">
      import { API_URL } from './config.js';

      let productos = [];
      const categoriasDisponibles = ["belleza y salud", "hogar", "tecnologia", "iluminacion"];

      // Llamar a esta funci√≥n al iniciar
      cargarOpcionesCategoria();

      let editando = false;

      async function cargarProductos() {
        tablaProductos.innerHTML = "";
        const productos = await getProducts();
        productos.forEach(prod => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${prod.name}</td>
      <td>$${prod.price}</td>
      <td>${prod.stock}</td>
      <td>${prod.category || "Sin categor√≠a"}</td>
      <td>
        <button class="btn-primary" onclick="editarProducto(${prod.id})">‚úèÔ∏è</button>
        <button class="btn-danger" onclick="eliminarProducto(${prod.id})">üóëÔ∏è</button>
      </td>
    `;
          tablaProductos.appendChild(tr);
        });
      }

      // Funci√≥n para llenar el <select> din√°micamente
      function cargarOpcionesCategoria() {
        const categorySelect = document.getElementById("category");
        categorySelect.innerHTML = `<option value="">Seleccionar categor√≠a</option>`;
        categoriasDisponibles.map(cat => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          categorySelect.appendChild(option);
        });
      }

      window.editarProducto = async (id) => {
        const producto = await getProductById(id);
        editando = true;
        formTitulo.textContent = "Editar Producto";
        formProducto.productId.value = producto.id;
        formProducto.name.value = producto.name;
        formProducto.description.value = producto.description || "";
        formProducto.category.value = producto.category || "";
        formProducto.price.value = producto.price;
        formProducto.image.value = producto.image || "";
        formProducto.stock.value = producto.stock;
        abrirModal();
      };

      window.eliminarProducto = async (id) => {
        if (confirm("¬øSeguro que deseas eliminar este producto?")) {
          await deleteProduct(id);
          cargarProductos();
        }
      };

      btnNuevo.addEventListener("click", () => {
        editando = false;
        formTitulo.textContent = "Agregar Nuevo Producto";
        formProducto.reset();
        abrirModal();
      });

      formProducto.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          name: formProducto.name.value,
          description: formProducto.description.value,
          category: formProducto.category.value,
          price: parseFloat(formProducto.price.value),
          image: formProducto.image.value,
          stock: parseInt(formProducto.stock.value)
        };

        if (editando) {
          await updateProduct(formProducto.productId.value, data);
        } else {
          await createProduct(data);
        }

        cerrarModal();
        cargarProductos();
      });

      closeModalBtn.addEventListener("click", cerrarModal);
      window.onclick = (event) => {
        if (event.target === modal) cerrarModal();
      };

      function abrirModal() {
        modal.style.display = "block";
      }

      function cerrarModal() {
        modal.style.display = "none";
      }

      cargarProductos();
    </script>
</body>

</html>