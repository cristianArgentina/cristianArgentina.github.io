<!-- admin.html -->
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="admin.css" />
  <link rel="stylesheet" href="./css/loaderadmin.css">
</head>

<body>
  <div id="login-box">
    <h2>Acceso restringido</h2>
    <input type="password" id="password" placeholder="Contrase√±a" />
    <button onclick="checkPassword()">Entrar</button>
    <p id="msg" style="color:red;"></p>
  </div>

  <div id="admin-content" style="display:none;">
    <h1>üì¶ Panel de Administraci√≥n</h1>
    <div class="tabs">
      <button id="tabProductos" class="btn-primary">üõí Productos</button>
      <button id="tabVentas" class="btn-secondary">üíµ Ventas</button>
    </div>
    <div id="vistaProductos">
      <button id="btnNuevo" class="btn-primary">‚ûï Agregar nuevo producto</button>
      <table id="tablaProductos">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Categor√≠a</th>
            <th>Acciones</th>
            <th>Lotes</th> <!-- nueva columna -->
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="vistaVentas" style="display:none;">
      <button id="btnNuevaVenta" class="btn-primary">‚ûï Registrar venta</button>
      <table id="tablaVentas">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Costo Unitario</th>
            <th>Ganancia</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <!-- addModal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span id="closeModalBtn" class="close">&times;</span>
      <h2 id="formTitulo">Agregar Producto</h2>
      <form id="formAddProducto">
        <input type="hidden" id="productId">

        <!-- Nombre -->
        <div class="form-group">
          <label for="productName">Nombre</label>
          <input type="text" id="name" class="form-control" required>
        </div>

        <!-- Descripci√≥n -->
        <div class="form-group">
          <label for="productDescription">Descripci√≥n</label>
          <textarea id="description" class="form-control"></textarea>
        </div>

        <!-- Precio + Stock en la misma fila -->
        <div class="form-row">
          <div class="form-group half">
            <label for="productPrice">Precio</label>
            <input type="number" id="price" class="form-control" required>
          </div>
          <div class="form-group half">
            <label for="productStock">Stock</label>
            <input type="number" id="stock" class="form-control" required>
          </div>
        </div>

        <!-- Categor√≠a -->
        <div class="form-group">
          <label for="productCategory">Categor√≠a</label>
          <select name="category" id="category" class="form-control" required></select>
        </div>

        <!-- Imagen -->
        <div class="form-group">
          <label for="productImagen">Imagen URL</label>
          <input type="text" id="image" class="form-control">
        </div>

        <button type="submit" class="btn-primary">üíæ Guardar</button>
      </form>
    </div>
  </div>
  <!-- editModal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span id="closeModalBtn" class="close">&times;</span>
      <h2 id="formTitulo">Editar Producto</h2>
      <form id="formEditProducto">
        <input type="hidden" id="productId">

        <!-- Nombre -->
        <div class="form-group">
          <label for="productName">Nombre</label>
          <input type="text" id="name" class="form-control" required>
        </div>

        <!-- Descripci√≥n -->
        <div class="form-group">
          <label for="productDescription">Descripci√≥n</label>
          <textarea id="description" class="form-control"></textarea>
        </div>

        <!-- Precio + Stock en la misma fila -->
        <div class="form-row">
          <div class="form-group half">
            <label for="productPrice">Precio</label>
            <input type="number" id="price" class="form-control" required>
          </div>
          <div class="form-group half">
            <label for="productStock">Stock</label>
            <input type="number" id="stock" class="form-control" required>
          </div>
        </div>

        <!-- Categor√≠a -->
        <div class="form-group">
          <label for="productCategory">Categor√≠a</label>
          <select name="category" id="category" class="form-control" required></select>
        </div>

        <!-- Imagen -->
        <div class="form-group">
          <label for="productImagen">Imagen URL</label>
          <input type="text" id="image" class="form-control">
        </div>

        <button type="submit" class="btn-primary">üíæ Guardar</button>
      </form>
      <!-- Secci√≥n de lotes separada -->
      <hr>
      <h3>üì¶ Lotes del producto</h3>
      <table id="tablaLotes">
        <thead>
          <tr>
            <th>Cantidad</th>
            <th>Costo Unitario</th>
            <th>Fecha Ingreso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Venta -->
  <div id="modalVenta" class="modal">
    <div class="modal-content">
      <span id="closeModalVenta" class="close">&times;</span>
      <h2>Registrar Venta</h2>
      <form id="formVenta">
        <label>Producto:</label>
        <select id="ventaProducto" required></select>

        <label>Cantidad:</label>
        <input type="number" id="ventaCantidad" required min="1">

        <label>Precio de venta unitario:</label>
        <input type="number" id="ventaPrecio" required step="0.01">

        <button type="submit" class="btn-primary">üíæ Guardar</button>
      </form>
    </div>
  </div>
  <script type="module">
    const claveCorrecta = "TuClaveSecreta123";

    function mostrarLogin() {
      document.getElementById("login-box").style.display = "block";
    }

    function mostrarAdmin() {
      document.getElementById("admin-content").style.display = "block";
    }

    // LOGIN
    function checkPassword() {
      const input = document.getElementById("password").value;
      if (input === claveCorrecta) {
        localStorage.setItem("logueadoAdmin", "true");
        location.reload();
      } else {
        document.getElementById("msg").textContent = "Contrase√±a incorrecta";
      }
    }

    if (localStorage.getItem("logueadoAdmin") === "true") {
      document.getElementById("login-box").style.display = "none";
      document.getElementById("admin-content").style.display = "block";
    }

    // Verificar al cargar
    if (localStorage.getItem("logueadoAdmin") === "true") {
      mostrarAdmin();
    } else {
      mostrarLogin();
    }
    window.checkPassword = checkPassword;
  </script>
  <script type="module">
    import { API_URL } from './config.js';
    import { getProducts, getProductById, createProduct, updateProduct, deleteProduct, addLote, deleteLote } from './api.js';
    import { showLoader, hideLoader } from "./js/loaderadmin.js";

    let productos = [];
    const categoriasDisponibles = ["belleza y salud", "hogar", "tecnologia", "iluminacion"];
    let productoActual = null;

    // Llamar a esta funci√≥n al iniciar
    cargarOpcionesCategoria();

    async function cargarProductos() {
      showLoader("Cargando productos... üê•");
      try {
        tablaProductos.innerHTML = "";
        const productos = await getProducts();
        productos.forEach(prod => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${prod.name}</td>
      <td>$${prod.price}</td>
      <td>${prod.stock}</td>
      <td>${prod.category || "Sin categor√≠a"}</td>
      <td>
        <button class="btn-primary" onclick="editarProducto(${prod.id})">‚úèÔ∏è</button>
        <button class="btn-danger" onclick="eliminarProducto(${prod.id})">üóëÔ∏è</button>
      </td>
      <td>
        <button class="btn-secondary" onclick="mostrarFormLote(${prod.id})">‚ûï Lote</button>
        <div id="formLote-${prod.id}" class="form-lote" style="display:none; margin-top:5px;">
          <input type="number" id="cantidad-${prod.id}" placeholder="Cantidad" min="1" required>
          <input type="number" id="costo-${prod.id}" placeholder="Costo unitario" step="0.01">
          <input type="date" id="fecha-${prod.id}">
          <button onclick="guardarLote(${prod.id})">Guardar</button>
        </div>
      </td>
    `;
          tablaProductos.appendChild(tr);
        });
      } finally {
        hideLoader();
      }
    }

    // Funci√≥n para llenar el <select> din√°micamente
    function cargarOpcionesCategoria() {
      const categorySelect = document.getElementById("category");
      categorySelect.innerHTML = `<option value="">Seleccionar categor√≠a</option>`;
      categoriasDisponibles.map(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
    }

    window.editarProducto = async (id) => {
      const producto = await getProductById(id);
      productoActual = producto;
      formTitulo.textContent = "Editar Producto";
      formEditProducto.productId.value = producto.id;
      formEditProducto.name.value = producto.name;
      formEditProducto.description.value = producto.description || "";
      formEditProducto.category.value = producto.category || "";
      formEditProducto.price.value = producto.price;
      formEditProducto.image.value = producto.image || "";
      formEditProducto.stock.value = producto.stock;

      renderLotes(producto.lotes);
      abrirModal();
    };

    function renderLotes(lotes) {
      const tbody = document.querySelector("#tablaLotes tbody");
      tbody.innerHTML = "";
      lotes.forEach((lote) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${lote.cantidad}</td>
      <td>${lote.costoUnitario ?? "-"}</td>
      <td>${new Date(lote.fechaIngreso).toLocaleDateString()}</td>
      <td>
        <button onclick="eliminarLote('${lote._id}')">üóëÔ∏è</button>
      </td>
    `;
        tbody.appendChild(tr);
      });
    }

    window.eliminarLote = async (loteId) => {
      if (confirm("¬øEliminar este lote?")) {
        await deleteLote(productoActual.id, loteId);
        const actualizado = await getProductById(productoActual.id);
        productoActual = actualizado;
        renderLotes(actualizado.lotes);
        cargarProductos();
      }
    };

    window.mostrarFormLote = (id) => {
      const form = document.getElementById(`formLote-${id}`);
      form.style.display = form.style.display === "none" ? "block" : "none";
    };

    window.guardarLote = async (id) => {
      const cantidad = parseInt(document.getElementById(`cantidad-${id}`).value);
      const costoUnitario = parseFloat(document.getElementById(`costo-${id}`).value) || null;
      const fechaIngreso = document.getElementById(`fecha-${id}`).value || null;

      if (!cantidad) {
        alert("La cantidad es obligatoria");
        return;
      }

      await addLote(id, { cantidad, costoUnitario, fechaIngreso });
      alert("‚úÖ Lote agregado correctamente");

      // refrescamos productos
      cargarProductos();
    };

    window.eliminarProducto = async (id) => {
      if (confirm("¬øSeguro que deseas eliminar este producto?")) {
        await deleteProduct(id);
        cargarProductos();
      }
    };

    btnNuevo.addEventListener("click", () => {
      formTitulo.textContent = "Agregar Nuevo Producto";
      formAddProducto.reset();
      abrirModal();
    });

    formAddProducto.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        name: formAddProducto.name.value,
        description: formAddProducto.description.value,
        category: formAddProducto.category.value,
        price: parseFloat(formAddProducto.price.value),
        image: formAddProducto.image.value,
        stock: parseInt(formAddProducto.stock.value)
      };
      await createProduct(data);
      cerrarModal();
      cargarProductos();
    });

    formEditProducto.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        name: formEditProducto.name.value,
        description: formEditProducto.description.value,
        category: formEditProducto.category.value,
        price: parseFloat(formEditProducto.price.value),
        image: formEditProducto.image.value,
        stock: parseInt(formEditProducto.stock.value)
      };
      await updateProduct(formEditProducto.productId.value, data);
      cerrarModal();
      cargarProductos();
    });

    closeModalBtn.addEventListener("click", cerrarModal);
    window.onclick = (event) => {
      if (event.target === modal) cerrarModal();
    };

    function abrirModal() {
      modal.style.display = "block";
    }

    function cerrarModal() {
      modal.style.display = "none";
    }

    cargarProductos();
  </script>
  <script type="module">
    import { getSales, createSale } from './api.js';
    import { getProducts } from './api.js';

    const vistaProductos = document.getElementById("vistaProductos");
    const vistaVentas = document.getElementById("vistaVentas");
    const btnNuevaVenta = document.getElementById("btnNuevaVenta");
    const tablaVentas = document.querySelector("#tablaVentas tbody");

    // Tabs
    tabProductos.addEventListener("click", () => {
      vistaProductos.style.display = "block";
      vistaVentas.style.display = "none";
    });
    tabVentas.addEventListener("click", () => {
      vistaProductos.style.display = "none";
      vistaVentas.style.display = "block";
      cargarVentas();
    });

    // Cargar ventas
    async function cargarVentas() {
      tablaVentas.innerHTML = "";
      const ventas = await getSales();
      ventas.forEach(v => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${new Date(v.createdAt).toLocaleDateString()}</td>
      <td>${v.productId}</td> 
      <td>${v.cantidad}</td>
      <td>$${v.precioVenta}</td>
      <td>$${v.precioCosto?.toFixed(2)}</td>
      <td>$${v.ganancia?.toFixed(2)}</td>
    `;
        tablaVentas.appendChild(tr);
      });
    }


    // Abrir modal venta
    btnNuevaVenta.addEventListener("click", async () => {
      const productos = await getProducts();
      const select = document.getElementById("ventaProducto");
      select.innerHTML = "";
      productos.forEach(p => {
        const option = document.createElement("option");
        option.value = p.id;
        option.textContent = p.name;
        select.appendChild(option);
      });
      modalVenta.style.display = "block";
    });

    // Guardar venta
    formVenta.addEventListener("submit", async (e) => {
      e.preventDefault();

      const productId = ventaProducto.value;
      const cantidad = parseInt(ventaCantidad.value);
      const precioVenta = parseFloat(ventaPrecio.value);

      await createSale({ productId, cantidad, precioVenta });

      modalVenta.style.display = "none";
      cargarVentas(); // refresca la tabla de ventas
    });

  </script>
</body>

</html>